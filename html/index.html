<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <style>
      #map {
        height: 400px;
        width: 100%;
      }
    </style>
    <title>Geolocalización</title>
  </head>
  <body>
    <div class="row px-3">
      <div class="col-12">
        <label for="ubicacion">Mis Coordenadas</label>
      </div>
    </div>

    <div id="resultMyCoords" class="px-3"></div>
    <br />

    <div class="row px-3">
      <div class="col-12">
        <label for="ubicacion">Coordenadas</label>
        <input type="text" id="coordsLatLng" class="form-control" />
      </div>
      <div class="col-12">
        <button id="btnUbi" class="btn btn-primary">
          Convertir a dirección
        </button>
      </div>
    </div>

    <div id="result" class="px-3"></div>
    <br />

    <div id="map"></div>

    <script>
      // mi localizacion
      navigator.geolocation.getCurrentPosition(success);
      function success(geolocationPosition) {
        let myCoords = geolocationPosition.coords;
        document.getElementById(
          "resultMyCoords"
        ).innerHTML = `<p>${myCoords.latitude}, ${myCoords.longitude}</p>`;
        console.log(geolocationPosition);
      }

      // iniciador de mapa
      function initMap() {
        let latitud = 19.2488203;
        let longitud = -103.7132869;

        coords = {
          lat: latitud,
          lng: longitud,
        };

        generarMap(coords);
      }

      // funcion que genera el mapa
      function generarMap(coords) {
        let map = new google.maps.Map(document.getElementById("map"), {
          zoom: 16,
          center: new google.maps.LatLng(coords.lat, coords.lng),
        });

        marker = new google.maps.Marker({
          position: new google.maps.LatLng(coords.lat, coords.lng),
          map: map,
          draggable: true,
        });

        marker.addListener("dragend", function (event) {
          document.getElementById(
            "coordsLatLng"
          ).value = `${this.getPosition().lat()}, ${this.getPosition().lng()}`;
        });

        // coords a direccion
        let geocoder = new google.maps.Geocoder();

        let infoWindow = new google.maps.InfoWindow();

        document.getElementById("btnUbi").addEventListener("click", () => {
          geocodeLatLng(geocoder, map, infoWindow);
        });
      }

      // funcion crear direccion con coordenas
      function geocodeLatLng(geocoder, map, infoWindow) {
        let input = document.getElementById("coordsLatLng").value;

        let latlngStr = input.split(",", 2);

        let coordsLatLng = {
          lat: parseFloat(latlngStr[0]),
          lng: parseFloat(latlngStr[1]),
        };

        geocoder
          .geocode({ location: coordsLatLng })
          .then((response) => {
            if (response.results[0]) {
              // cambiar el punto
              coords = {
                lat: parseFloat(latlngStr[0]),
                lng: parseFloat(latlngStr[1]),
              };

              generarMap(coords);

              marker = new google.maps.Marker({
                position: coordsLatLng,
                map: map,
              });

              infoWindow.setContent(response.results[0].formatted_address);
              document.getElementById(
                "result"
              ).innerHTML = `<p>${response.results[0].formatted_address}</p>`;
            }
          })
          .catch((e) => console.log(e));
      }
      window.initMap = initMap;
    </script>

    <!-- API GOOGLE MAPS -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqRArrD1kuzHBHQVawpJEsH1UoDOsLiwc&callback=initMap&v=weekly"
      defer
    ></script>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <!-- jquery-3 -->
    <script
      src="https://code.jquery.com/jquery-3.6.0.js"
      integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
      crossorigin="anonymous"
    ></script>
  </body>
</html>
